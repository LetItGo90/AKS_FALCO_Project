---
- name: Deploy Kubernetes Threat Detection Lab
  hosts: localhost
  connection: local
  vars:
    resource_group: k8_project
    location: eastus
    aks_cluster_name: aks1
    log_analytics_workspace: falco-logs
    falco_namespace: falco

  tasks:
    # ==================== AZURE INFRASTRUCTURE ====================
    - name: Create Resource Group
      azure.azcollection.azure_rm_resourcegroup:
        name: "{{ resource_group }}"
        location: "{{ location }}"
        tags:
          Environment: Production

    - name: Create Log Analytics Workspace
      azure.azcollection.azure_rm_loganalyticsworkspace:
        name: "{{ log_analytics_workspace }}"
        resource_group: "{{ resource_group }}"
        location: "{{ location }}"
        sku: PerGB2018
        retention_in_days: 30
      register: law_result

    # ==================== HELM REPOSITORIES ====================
    - name: Add Falco Helm repository
      kubernetes.core.helm_repository:
        name: falcosecurity
        repo_url: https://falcosecurity.github.io/charts

    # ==================== FALCO DEPLOYMENT ====================
    - name: Create Falco namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ falco_namespace }}"

    - name: Deploy Falco with custom rules
      kubernetes.core.helm:
        name: falco
        chart_ref: falcosecurity/falco
        release_namespace: "{{ falco_namespace }}"
        create_namespace: true
        values:
          driver:
            kind: ebpf
          falco:
            grpc:
              enabled: true
            grpcOutput:
              enabled: true
            jsonOutput: true
            jsonIncludeOutputProperty: true
          falcosidekick:
            enabled: true
          customRules:
            custom-rules.yaml: |
              - rule: Shell Activity in Container
                desc: Detect shell activity within a container
                condition: spawned_process and container and proc.name in (bash, sh, zsh, ash)
                output: "Shell spawned in container (user=%user.name command=%proc.cmdline container=%container.name pod=%k8s.pod.name namespace=%k8s.ns.name)"
                priority: WARNING
                tags: [shell, container]
              
              - rule: Sensitive File Access
                desc: Detect access to sensitive files
                condition: open_read and container and fd.name in (/etc/shadow, /etc/passwd, /etc/sudoers)
                output: "Sensitive file accessed (user=%user.name file=%fd.name container=%container.name pod=%k8s.pod.name namespace=%k8s.ns.name)"
                priority: WARNING
                tags: [filesystem, container]

    # ==================== ENABLE CONTAINER INSIGHTS ====================
    - name: Enable Container Insights on AKS
      azure.azcollection.azure_rm_aks:
        name: "{{ aks_cluster_name }}"
        resource_group: "{{ resource_group }}"
        addon:
          monitoring:
            enabled: true
            log_analytics_workspace_resource_id: "{{ law_result.id }}"

    # ==================== VERIFICATION ====================
    - name: Wait for Falco pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ falco_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=falco
      register: falco_pods
      until: falco_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
      retries: 30
      delay: 10

    - name: Display deployment status
      debug:
        msg: |
          ============================================
          Kubernetes Threat Detection Lab Deployed!
          ============================================
          - Falco namespace: {{ falco_namespace }}
          - Log Analytics workspace: {{ log_analytics_workspace }}
          - Falco pods running: {{ falco_pods.resources | length }}
          
          Query Falco alerts with:
          az monitor log-analytics query --workspace "{{ law_result.properties.customerId }}" --analytics-query "ContainerLogV2 | where PodNamespace == 'falco' | where ContainerName == 'falco' | take 10"
          ============================================
